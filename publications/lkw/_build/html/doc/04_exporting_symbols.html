

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>1. EXPORT_SYMBOL &#8212; Linux Kernel Workbook 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../_static/cloud.js"></script>
    <link rel="top" title="Linux Kernel Workbook 1.0 documentation" href="../wip.index.html" />
    <link rel="prev" title="4. Kernel Modules" href="03_kernel_modules.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body role="document">
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="03_kernel_modules.html" title="4. Kernel Modules"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">Linux Kernel Workbook 1.0 documentation</a> &#187;</li>
 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="export-symbol">
<h1>1. EXPORT_SYMBOL<a class="headerlink" href="#export-symbol" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>1.1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Genrally the modules will never live alone. We need to divide the code into
multiple modules for better organization and readlibilty as well as we need to
use the APIs or functionality which is available in other modules or the
functions which are made available to us by the Linux Kernel.</p>
<p>Here in this chapter we will see how to make our functions available to other
modules. In latter chapters we will use some functionality given by the other
modules or the kernel code.</p>
<div class="section" id="why-this-chapter">
<h3>1.1.1. Why this chapter<a class="headerlink" href="#why-this-chapter" title="Permalink to this headline">¶</a></h3>
<p>We need to understand how to</p>
<ul class="simple">
<li>For making a function available for others to use.</li>
<li>How to use functions given by other modules.</li>
</ul>
</div>
<div class="section" id="what-will-you-learn">
<h3>1.1.2. What will you learn<a class="headerlink" href="#what-will-you-learn" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Exporting an API to an external module.</li>
<li>Using API given by the other module.</li>
<li>Using library functions available in kernel.</li>
</ul>
</div>
<div class="section" id="prerequisites">
<h3>1.1.3. Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h3>
<p>Previous chapters.</p>
</div>
</div>
<div class="section" id="id1">
<h2>1.2. Export Symbol<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">EXPORT_SYMBOL()</span></code> helps you provide APIs to other modules/code.</li>
<li>The functions which you EXPORT are available to the other modules/code.</li>
<li>Your module will not load if the its expecting a symbol(variable/function) and its not present in the kernel.</li>
<li><code class="docutils literal"><span class="pre">modprobe</span></code> helps here and loads the modules which is needed by your module.</li>
<li>What if there is circular dependancy between the modules?</li>
</ul>
</div>
<div class="section" id="module-exporting-some-functions-and-variables">
<h2>1.3. Module Exporting Some Functions and Variables<a class="headerlink" href="#module-exporting-some-functions-and-variables" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id2">
<h3>1.3.1. Introduction<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Here we will write two modules. In one module we will have the functions
which will be exported using the <code class="docutils literal"><span class="pre">EXPORT_SYMBOL()</span></code> whereas the other
module will just call the functions and use the variables which are exported.</li>
<li>We will then see the details of the module by seeing the <code class="docutils literal"><span class="pre">modinfo</span>
<span class="pre">command</span></code>. See the <code class="docutils literal"><span class="pre">depends</span></code> field of the output. In <code class="docutils literal"><span class="pre">mymodule1.ko</span></code> you
will see that it depends on <code class="docutils literal"><span class="pre">mymodule1</span></code>.</li>
</ul>
</div>
<div class="section" id="file-mymodule1-c">
<h3>1.3.2. <code class="docutils literal"><span class="pre">FILE:</span> <span class="pre">mymodule1.c</span></code><a class="headerlink" href="#file-mymodule1-c" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * &lt;PD&gt; Module 1 for demonstration of circular dependancy &lt;/PD&gt;</span>
<span class="cm"> */</span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/init.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="n">GLOBAL_VARIABLE</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">GLOBAL_VARIABLE</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Function to print hello for num times.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">print_hello</span><span class="p">(</span><span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">num</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Hello Friend!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">print_hello</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Function to add two passed number.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">add_two_numbers</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Sum of the numbers %d&quot;</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">add_two_numbers</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">my_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Hello from Export Symbol 1 module.&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">my_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Bye from Export Symbol 1 module.&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">my_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">my_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Module to demonstrate the EXPORT_SYMBOL functionality&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Rishi Agrawal &lt;rishi.b.agrawal@gmail.com&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="file-mymodule2-c">
<h3>1.3.3. <code class="docutils literal"><span class="pre">FILE:</span> <span class="pre">mymodule2.c</span></code><a class="headerlink" href="#file-mymodule2-c" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * &lt;PD&gt; Module 2 for exporting symbol demostration &lt;/PD&gt;</span>
<span class="cm"> */</span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/init.h&gt;</span><span class="cp"></span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">print_hello</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">add_two_numbers</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">GLOBAL_VARIABLE</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * The function has been written just to call the functions which are in other module. This way you can also write modules which does provide some functionality to the other modules.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">my_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Hello from Hello Module&quot;</span><span class="p">);</span>
    <span class="n">print_hello</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
    <span class="n">add_two_numbers</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Value of GLOBAL_VARIABLE %d&quot;</span><span class="p">,</span> <span class="n">GLOBAL_VARIABLE</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">my_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Bye from Hello Module&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">my_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">my_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Module to demonstrate the EXPORT_SYMBOL functionality&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Rishi Agrawal &lt;rishi.b.agrawal@gmail.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="file-makefile">
<h3>1.3.4. <code class="docutils literal"><span class="pre">FILE:</span> <span class="pre">Makefile</span></code><a class="headerlink" href="#file-makefile" title="Permalink to this headline">¶</a></h3>
<div class="highlight-make"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nv">obj-m</span> <span class="o">+=</span>  mymodule1.o
<span class="nv">obj-m</span> <span class="o">+=</span>  mymodule2.o

<span class="k">export </span><span class="nv">KROOT</span><span class="o">=</span>/lib/modules/<span class="k">$(</span>shell uname -r<span class="k">)</span>/build

<span class="nf">allofit</span><span class="o">:</span>  <span class="n">modules</span>
<span class="nf">modules</span><span class="o">:</span>
	@<span class="k">$(</span>MAKE<span class="k">)</span> -C <span class="k">$(</span>KROOT<span class="k">)</span> <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span> modules
<span class="nf">modules_install</span><span class="o">:</span>
	@<span class="k">$(</span>MAKE<span class="k">)</span> -C <span class="k">$(</span>KROOT<span class="k">)</span> <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span> modules_install
<span class="nf">kernel_clean</span><span class="o">:</span>
	@<span class="k">$(</span>MAKE<span class="k">)</span> -C <span class="k">$(</span>KROOT<span class="k">)</span> <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span> clean

<span class="nf">clean</span><span class="o">:</span> <span class="n">kernel_clean</span>
	rm -rf   Module.symvers modules.order
</pre></div>
</td></tr></table></div>
<ul class="simple">
<li>Let us see what <code class="docutils literal"><span class="pre">modinfo</span></code> tells about our modules. Before this compile the modules.</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ modinfo mymodule1.ko
filename:       /home/rishi/mydev/publications/lkw/doc/code/04_exporting_symbols/exporting_symbols/mymodule1.ko
license:        GPL v2
author:         Rishi Agrawal &lt;rishi.b.agrawal@gmail.com
description:    Module to demonstrate the EXPORT_SYMBOL functionality
depends:
vermagic:       4.7.0 SMP mod_unload

$ modinfo mymodule2.ko
filename:       /home/rishi/mydev/publications/lkw/doc/code/04_exporting_symbols/exporting_symbols/mymodule2.ko
license:        GPL v2
author:         Rishi Agrawal &lt;rishi.b.agrawal@gmail.com&gt;
description:    Module to demonstrate the EXPORT_SYMBOL functionality
depends:        mymodule1    &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
vermagic:       4.7.0 SMP mod_unload
</pre></div>
</div>
<ul class="simple">
<li>Let us try to insert the <code class="docutils literal"><span class="pre">mymodule2.ko</span></code> before the <code class="docutils literal"><span class="pre">mymodule1.ko</span></code>. It will give errors.</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ sudo insmod mymodule2.ko
insmod: ERROR: could not insert module mymodule2.ko: Unknown symbol in module

rishi@rishi-VirtualBox:~/mydev/publications/lkw/doc/code/04_exporting_symbols/exporting_symbols$ dmesg
[15588.009164] mymodule2: Unknown symbol add_two_numbers (err 0)
[15588.009171] mymodule2: Unknown symbol GLOBAL_VARIABLE (err 0)
[15588.009176] mymodule2: Unknown symbol print_hello (err 0)
</pre></div>
</div>
<ul class="simple">
<li>Now insert the <code class="docutils literal"><span class="pre">mymodule1.ko</span></code></li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ sudo insmod mymodule1.ko
</pre></div>
</div>
<ul class="simple">
<li>Now insert the <code class="docutils literal"><span class="pre">mymodule2.ko</span></code></li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ sudo insmod mymodule2.ko
[15606.692155] Hello from Export Symbol 1 module.
[15612.175760] Hello from Hello Module
[15612.175764] Hello Friend!!!
[15612.175766] Hello Friend!!!
[15612.175767] Hello Friend!!!
[15612.175769] Hello Friend!!!
[15612.175770] Hello Friend!!!
[15612.175772] Hello Friend!!!
[15612.175773] Hello Friend!!!
[15612.175775] Hello Friend!!!
[15612.175776] Hello Friend!!!
[15612.175778] Hello Friend!!!
[15612.175780] Sum of the numbers 11
[15612.175782] Value of GLOBAL_VARIABLE 1000
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">SUCESSS</span> <span class="pre">!!</span></code> You have sucessfully inserted a module which uses functions from another module.</li>
</ul>
</div>
</div>
<div class="section" id="removing-the-modules">
<h2>1.4. Removing the modules<a class="headerlink" href="#removing-the-modules" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>You cannot remove a module which is in use.</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ sudo rmmod mymodule1
rmmod: ERROR: Module mymodule1 is in use by: mymodule2
</pre></div>
</div>
<ul class="simple">
<li>Check who is using the <code class="docutils literal"><span class="pre">mymodule1</span></code>. See the <code class="docutils literal"><span class="pre">Used</span> <span class="pre">by</span></code> column in the <code class="docutils literal"><span class="pre">lsmod</span></code> output.</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ lsmod
Module                  Size  Used by
mymodule2               1056  0
mymodule1               1324  1 mymodule2
</pre></div>
</div>
<ul class="simple">
<li>We will have to remove the <code class="docutils literal"><span class="pre">mymodule2</span></code> first and <code class="docutils literal"><span class="pre">mymodule1</span></code>.</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ sudo rmmod mymodule2
$ sudo rmmod mymodule1
</pre></div>
</div>
</div>
<div class="section" id="other-files">
<h2>1.5. Other files<a class="headerlink" href="#other-files" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>See the <code class="docutils literal"><span class="pre">Module.order</span></code> file. It has the order in which the modules should be loaded.</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ cat modules.order
kernel//home/rishi/mydev/publications/lkw/doc/code/04_exporting_symbols/exporting_symbols/mymodule1.ko
kernel//home/rishi/mydev/publications/lkw/doc/code/04_exporting_symbols/exporting_symbols/mymodule2.ko
</pre></div>
</div>
<ul class="simple">
<li>See the <code class="docutils literal"><span class="pre">Module.symvers</span></code> file. It shows the symbols which are exported.</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ cat Module.symvers
0x00000000  print_hello /home/rishi/mydev/publications/lkw/doc/code/04_exporting_symbols/exporting_symbols/mymodule1    EXPORT_SYMBOL
0x00000000  add_two_numbers /home/rishi/mydev/publications/lkw/doc/code/04_exporting_symbols/exporting_symbols/mymodule1    EXPORT_SYMBOL
0x00000000  GLOBAL_VARIABLE /home/rishi/mydev/publications/lkw/doc/code/04_exporting_symbols/exporting_symbols/mymodule1    EXPORT_SYMBOL
</pre></div>
</div>
</div>
<div class="section" id="see-the-exported-symbols">
<h2>1.6. See the exported symbols<a class="headerlink" href="#see-the-exported-symbols" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">Module1 exports the symbols.</p>
</li>
<li><p class="first">The exported symbols and other functions in the kernel can be seen in the <code class="docutils literal"><span class="pre">/proc/kallsyms</span></code> file.  Its is a huge file.</p>
</li>
<li><p class="first">Let us see the difference in the file after inserting the <code class="docutils literal"><span class="pre">mymodule1.ko</span></code>.</p>
</li>
<li><p class="first">That file clearly that the functions <code class="docutils literal"><span class="pre">print_hello()</span></code> and others are from <code class="docutils literal"><span class="pre">mymodule1</span></code>.</p>
</li>
<li><p class="first">The UpperCase <code class="docutils literal"><span class="pre">T</span></code> says that the functions are exported (available for others to use) while a lowercase says its not <code class="docutils literal"><span class="pre">exported</span></code>.</p>
</li>
<li><p class="first">Run the following commands to make two files with the list of synbols.</p>
<p><code class="docutils literal"><span class="pre">cat</span> <span class="pre">/proc/kallsyms</span> <span class="pre">&gt;</span> <span class="pre">/tmp/1</span></code></p>
</li>
<li><p class="first">Insert our module.</p>
<p><code class="docutils literal"><span class="pre">insmod</span> <span class="pre">mymodule1.ko</span></code></p>
</li>
<li><p class="first">Save the symbols in another file.</p>
<p><code class="docutils literal"><span class="pre">cat</span> <span class="pre">/proc/kallsyms</span> <span class="pre">&gt;</span> <span class="pre">/tmp/2</span></code></p>
</li>
<li><p class="first">See the difference.</p>
</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>diff /tmp/1 /tmp/2
41353a41354,41357
&gt; 0000000000000000 t my_exit    [mymodule1]
&gt; 0000000000000000 t cleanup_module [mymodule1]
&gt; 0000000000000000 T add_two_numbers    [mymodule1]
&gt; 0000000000000000 T print_hello    [mymodule1]
 $ ~/mydev/publications/lkw/doc/code/04_exporting_symbols/exporting_symbols
</pre></div>
</div>
</div>
<div class="section" id="tool-modprobe">
<h2>1.7. Tool modprobe<a class="headerlink" href="#tool-modprobe" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Modprobe understands in which order the modules are to be loaded.</li>
<li>First remove the modules.</li>
<li>Run the command <code class="docutils literal"><span class="pre">modprobe</span> <span class="pre">module2</span></code> loads both the module.</li>
</ul>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">Write section on modprobe</p>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ sudo modprobe mymodule2
modprobe: FATAL: Module mymodule2 not found in directory /lib/modules/4.7.0

$ sudo modprobe mymodule2.ko
modprobe: FATAL: Module mymodule2.ko not found in directory /lib/modules/4.7.0

$ sudo modprobe -C . mymodule2.ko
modprobe: FATAL: Module mymodule2.ko not found in directory /lib/modules/4.7.0

$ man modprobe

$ sudo modprobe -d . mymodule2.ko
modprobe: ERROR: ../libkmod/libkmod.c:586 kmod_search_moddep() could not open moddep file &#39;/home/rishi/mydev/publications/lkw/doc/code/04_exporting_symbols/exporting_symbols/./lib/modules/4.7.0/modules.dep.bin&#39;
modprobe: FATAL: Module mymodule2.ko not found in directory /home/rishi/mydev/publications/lkw/doc/code/04_exporting_symbols/exporting_symbols/./lib/modules/4.7.0
</pre></div>
</div>
</div>
<div class="section" id="tool-depmod">
<h2>1.8. Tool - depmod<a class="headerlink" href="#tool-depmod" title="Permalink to this headline">¶</a></h2>
<div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p class="last">Write this section on depmod.</p>
</div>
<ul>
<li><dl class="first docutils">
<dt><strong>DONT RUN IT</strong> Depmod is smart enough to find the dependancies and write to a file - don&#8217;t run it as it will overwrite the original file. First take backup of the file.</dt>
<dd><p class="first last"><code class="docutils literal"><span class="pre">depmod</span> <span class="pre">ABSOLUTE_PATH_OF_THE_MODULE1</span> <span class="pre">ABSOLUTE_PATH_OF_THE_MODULE2</span></code>
see the file <code class="docutils literal"><span class="pre">/modules/3.2.0-23-generic/modules.dep</span></code></p>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="one-module-dependent-on-several-modules">
<h2>1.9. One module dependent on several modules<a class="headerlink" href="#one-module-dependent-on-several-modules" title="Permalink to this headline">¶</a></h2>
<div class="section" id="modprobe-automatically-loading-all-the-modules">
<h3>1.9.1. <code class="docutils literal"><span class="pre">modprobe</span></code> automatically loading all the modules.<a class="headerlink" href="#modprobe-automatically-loading-all-the-modules" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="string-related-functions-available-in-kernel">
<h2>1.10. String related functions available in kernel<a class="headerlink" href="#string-related-functions-available-in-kernel" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>There are a lot of function related to string operations available in the Linux Kernel for you to use. They all are exported.</li>
<li>See the output of <code class="docutils literal"><span class="pre">/proc/kallsyms</span></code>.</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ cat /proc/kallsyms | grep &quot;T str&quot;
0000000000000000 T strndup_user
0000000000000000 T string_to_security_class
0000000000000000 T string_to_av_perm
0000000000000000 T strcasecmp
0000000000000000 T strcpy
0000000000000000 T strncpy
0000000000000000 T strcat
0000000000000000 T strcmp
0000000000000000 T strncmp
0000000000000000 T strchr
0000000000000000 T strchrnul
0000000000000000 T strrchr
0000000000000000 T strnchr
0000000000000000 T strlen
0000000000000000 T strnlen
0000000000000000 T strspn
0000000000000000 T strcspn
0000000000000000 T strpbrk
0000000000000000 T strsep
0000000000000000 T strtobool
0000000000000000 T strstr
0000000000000000 T strnstr
0000000000000000 T strlcpy
0000000000000000 T strncasecmp
0000000000000000 T strnicmp
0000000000000000 T strncat
0000000000000000 T strim
0000000000000000 T strlcat
0000000000000000 T string_get_size
0000000000000000 T string_unescape
0000000000000000 T string_escape_mem
0000000000000000 T strncpy_from_user
0000000000000000 T strnlen_user
0000000000000000 T strlen_user
0000000000000000 T strict_strtoul_scaled
</pre></div>
</div>
<ul class="simple">
<li>The count of exported functions is</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">kallsyms</span> <span class="o">|</span> <span class="n">grep</span> <span class="s2">&quot;T &quot;</span> <span class="o">|</span> <span class="n">wc</span> <span class="o">-</span><span class="n">l</span>
<span class="mi">18388</span>
</pre></div>
</div>
<ul class="simple">
<li>Let us now see how can we make use of one of the string functions that is <code class="docutils literal"><span class="pre">strcat()</span></code>. In the following module we will just concatenate two strings and will print the output.</li>
</ul>
<div class="section" id="file-mystring-c">
<h3>1.10.1. <code class="docutils literal"><span class="pre">FILE:</span> <span class="pre">mystring.c</span></code><a class="headerlink" href="#file-mystring-c" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * &lt;PD&gt; String functions available in the kernel. &lt;/PD&gt;</span>
<span class="cm"> */</span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/init.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">my_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">str1</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Hello&quot;</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">str2</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;World&quot;</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">dest</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">dest</span> <span class="o">=</span> <span class="n">strcat</span><span class="p">(</span><span class="n">str1</span><span class="p">,</span> <span class="n">str2</span><span class="p">);</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Concated String is %s&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">my_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Bye from Hello Module&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">my_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">my_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Sample Module using string functions.&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Rishi Agrawal &lt;rishi.b.agrawal@gmail.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Apache&quot;</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id3">
<h3>1.10.2. <code class="docutils literal"><span class="pre">FILE:</span> <span class="pre">Makefile</span></code><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="highlight-make"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nv">MODULE_FILENAME</span><span class="o">=</span>mystring

<span class="nv">obj-m</span> <span class="o">+=</span>  <span class="k">$(</span>MODULE_FILENAME<span class="k">)</span>.o
<span class="nv">KO_FILE</span><span class="o">=</span><span class="k">$(</span>MODULE_FILENAME<span class="k">)</span>.ko

<span class="k">export </span><span class="nv">KROOT</span><span class="o">=</span>/lib/modules/<span class="k">$(</span>shell uname -r<span class="k">)</span>/build

<span class="nf">modules</span><span class="o">:</span>
	@<span class="k">$(</span>MAKE<span class="k">)</span> -C <span class="k">$(</span>KROOT<span class="k">)</span> <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span> modules

<span class="nf">modules_install</span><span class="o">:</span>
	@<span class="k">$(</span>MAKE<span class="k">)</span> -C <span class="k">$(</span>KROOT<span class="k">)</span> <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span> modules_install

<span class="nf">clean</span><span class="o">:</span> 
	@<span class="k">$(</span>MAKE<span class="k">)</span> -C <span class="k">$(</span>KROOT<span class="k">)</span> <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span> clean
	rm -rf   Module.symvers modules.order

<span class="nf">insert</span><span class="o">:</span>
	sudo insmod <span class="k">$(</span>KO_FILE<span class="k">)</span>

<span class="nf">remove</span><span class="o">:</span>
	sudo rmmod <span class="k">$(</span>MODULE_FILENAME<span class="k">)</span>

<span class="nf">printlog</span><span class="o">:</span>
	sudo dmesg -c 
	sudo insmod <span class="k">$(</span>KO_FILE<span class="k">)</span>
	dmesg
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="exercises">
<h2>1.11. Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h2>
<p>The exercises here will generally not make much sense with respect to kernel
development. You will not be writing a feature for the kernel but you will be
learning how to do the basics. So you MUST do it.</p>
<ol class="arabic simple">
<li>Write a kernel module to which we can pass a string and it does the following. It must have the functions exported so that another kernel module can use the functions.
#.  Find the length of the string. <code class="docutils literal"><span class="pre">mystring_find_length()</span></code>
#.  Returns the reverse of the string.   <code class="docutils literal"><span class="pre">mystring_get_reverse()</span></code>
#.  Returns the rotation of the string by 3 places.  <code class="docutils literal"><span class="pre">char</span> <span class="pre">*mystring_get_rotated(char</span> <span class="pre">*srcstr,</span> <span class="pre">char</span> <span class="pre">*deststr,</span> <span class="pre">int</span> <span class="pre">rotations,</span> <span class="pre">int</span> <span class="pre">direction)</span></code>
#.  Returns if the string is palindrome or not.  <code class="docutils literal"><span class="pre">int</span> <span class="pre">mystring_is_palindrome(char</span> <span class="pre">*str)</span></code>
#.  Returns a character array where you have saved only the characters which are present in the even indexes.
#.  Returns a string which has all the letter capitalized.
#.  Returns a string which has all the letter converted to lowercase.</li>
<li>For the above kernel module write a testcase module which will call the functions and test if the functions are working correctly.</li>
</ol>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="sphinxlocaltoc">
    <h3><a href="../wip.index.html">Page contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">1. EXPORT_SYMBOL</a><ul>
<li><a class="reference internal" href="#introduction">1.1. Introduction</a><ul>
<li><a class="reference internal" href="#why-this-chapter">1.1.1. Why this chapter</a></li>
<li><a class="reference internal" href="#what-will-you-learn">1.1.2. What will you learn</a></li>
<li><a class="reference internal" href="#prerequisites">1.1.3. Prerequisites</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id1">1.2. Export Symbol</a></li>
<li><a class="reference internal" href="#module-exporting-some-functions-and-variables">1.3. Module Exporting Some Functions and Variables</a><ul>
<li><a class="reference internal" href="#id2">1.3.1. Introduction</a></li>
<li><a class="reference internal" href="#file-mymodule1-c">1.3.2. <code class="docutils literal"><span class="pre">FILE:</span> <span class="pre">mymodule1.c</span></code></a></li>
<li><a class="reference internal" href="#file-mymodule2-c">1.3.3. <code class="docutils literal"><span class="pre">FILE:</span> <span class="pre">mymodule2.c</span></code></a></li>
<li><a class="reference internal" href="#file-makefile">1.3.4. <code class="docutils literal"><span class="pre">FILE:</span> <span class="pre">Makefile</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#removing-the-modules">1.4. Removing the modules</a></li>
<li><a class="reference internal" href="#other-files">1.5. Other files</a></li>
<li><a class="reference internal" href="#see-the-exported-symbols">1.6. See the exported symbols</a></li>
<li><a class="reference internal" href="#tool-modprobe">1.7. Tool modprobe</a></li>
<li><a class="reference internal" href="#tool-depmod">1.8. Tool - depmod</a></li>
<li><a class="reference internal" href="#one-module-dependent-on-several-modules">1.9. One module dependent on several modules</a><ul>
<li><a class="reference internal" href="#modprobe-automatically-loading-all-the-modules">1.9.1. <code class="docutils literal"><span class="pre">modprobe</span></code> automatically loading all the modules.</a></li>
</ul>
</li>
<li><a class="reference internal" href="#string-related-functions-available-in-kernel">1.10. String related functions available in kernel</a><ul>
<li><a class="reference internal" href="#file-mystring-c">1.10.1. <code class="docutils literal"><span class="pre">FILE:</span> <span class="pre">mystring.c</span></code></a></li>
<li><a class="reference internal" href="#id3">1.10.2. <code class="docutils literal"><span class="pre">FILE:</span> <span class="pre">Makefile</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercises">1.11. Exercises</a></li>
</ul>
</li>
</ul>

  </div>
  <div class="sphinxprev">
    <h4>Previous page</h4>
    <p class="topless"><a href="03_kernel_modules.html"
                          title="Previous page">&larr; 4. Kernel Modules</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/doc/04_exporting_symbols.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="03_kernel_modules.html" title="4. Kernel Modules"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">Linux Kernel Workbook 1.0 documentation</a> &#187;</li>
 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Rishi Agrawal.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.6.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>